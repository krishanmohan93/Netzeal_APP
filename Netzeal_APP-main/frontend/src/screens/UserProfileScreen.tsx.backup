/**
 * User Public Profile Screen
 * Displays any user's profile with real data, posts, and follow status.
 */

import React, { useState, useCallback, useMemo, useEffect, useRef } from 'react';
import {
    View,
    Text,
    Image,
    TouchableOpacity,
    FlatList,
    StyleSheet,
    Dimensions,
    Alert,
    Linking,
    RefreshControl,
    useColorScheme,
    ActivityIndicator,
    Share,
    StatusBar,
} from 'react-native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import { Ionicons, MaterialIcons } from '@expo/vector-icons';
import { contentAPI, socialAPI } from '../services/api';

const { width: SCREEN_WIDTH } = Dimensions.get('window');

// ============================================================================
// TYPES
// ============================================================================

interface UserProfile {
    id: string;
    username: string;
    full_name?: string;
    bio?: string;
    profile_picture?: string;
    followers_count: number;
    following_count: number;
    posts_count: number;
    is_verified?: boolean;
    is_following?: boolean;
    website?: string;
    category?: string;
}

interface Post {
    id: string;
    media_url?: string; // Some endpoints return media_url
    image_url?: string; // Some return image_url
    type: 'post' | 'reel' | 'video';
    media_type?: 'image' | 'video' | 'reel';
    likes_count?: number;
    comments_count?: number;
    thumbnail_url?: string;
    media_urls?: string[] | string;
}

type TabType = 'posts' | 'reels';

// ============================================================================
// MAIN COMPONENT
// ============================================================================

export default function UserProfileScreen({ navigation, route }: any) {
    const insets = useSafeAreaInsets();
    const colorScheme = useColorScheme();
    const isDark = colorScheme === 'dark';
    const scrollRef = useRef<FlatList>(null);

    // Get userId from navigation params
    const { userId } = route.params || {};

    // ============================================================================
    // STATE
    // ============================================================================
    const [user, setUser] = useState<UserProfile | null>(null);
    const [posts, setPosts] = useState<Post[]>([]);
    const [activeTab, setActiveTab] = useState<TabType>('posts');
    const [loading, setLoading] = useState(true);
    const [refreshing, setRefreshing] = useState(false);
    const [error, setError] = useState<string | null>(null);

    // Follow/Unfollow loading state
    const [followLoading, setFollowLoading] = useState(false);

    // ============================================================================
    // THEME COLORS (EXACT INSTAGRAM)
    // ============================================================================
    const colors = useMemo(
        () => ({
            background: isDark ? '#000000' : '#FFFFFF',
            text: isDark ? '#FFFFFF' : '#000000',
            textSecondary: isDark ? '#A8A8A8' : '#737373',
            border: isDark ? '#262626' : '#DBDBDB',
            buttonBg: isDark ? '#262626' : '#EFEFEF',
            primary: '#0095F6',
            cardBg: isDark ? '#1A1A1A' : '#F6F6F6',
            headerBg: isDark ? '#000000' : '#FAFAFA',
            followBtn: '#0095F6',
            followingBtn: isDark ? '#262626' : '#EFEFEF',
            followingText: isDark ? '#FFFFFF' : '#000000',
            followText: '#FFFFFF',
        }),
        [isDark]
    );

    // ============================================================================
    // DATA FETCHING
    // ============================================================================
    const fetchProfileData = useCallback(async () => {
        if (!userId) {
            setError("User ID missing");
            setLoading(false);
            return;
        }

        try {
            setLoading(true);
            setError(null);

            // 1. Fetch User Profile
            // const userResponse = await socialAPI.getPublicProfile(userId);
            // userResponse should match UserProfile interface
            const userResponse = await socialAPI.getPublicProfile(userId);
            setUser(userResponse);

            // 2. Fetch User Posts
            try {
                const postsResponse = await contentAPI.getUserPosts(userId);
                setPosts(postsResponse || []);
            } catch (postsError) {
                console.log('Failed to load posts:', postsError);
                // Don't fail entire screen if posts fail
            }

        } catch (err: any) {
            console.error('Profile fetch error:', err);
            setError(err?.response?.data?.detail || 'Failed to load profile');
        } finally {
            setLoading(false);
            setRefreshing(false);
        }
    }, [userId]);

    useEffect(() => {
        fetchProfileData();
    }, [fetchProfileData]);

    const onRefresh = useCallback(() => {
        setRefreshing(true);
        fetchProfileData();
    }, [fetchProfileData]);

    // ============================================================================
    // ACTION HANDLERS
    // ============================================================================

    const handleFollowToggle = async () => {
        if (!user || followLoading) return;

        try {
            setFollowLoading(true);

            // Optimistic update
            const previousState = user.is_following;
            const previousCount = user.followers_count;

            setUser(prev => prev ? ({
                ...prev,
                is_following: !prev.is_following,
                followers_count: prev.is_following ? prev.followers_count - 1 : prev.followers_count + 1
            }) : null);

            // API Call
            await socialAPI.toggleConnection(user.id);

            // Success (optimistic update holds)
        } catch (err) {
            console.error('Follow toggle error:', err);
            // Revert on error
            fetchProfileData(); // Re-fetch to be safe
            Alert.alert("Error", "Failed to update follow status.");
        } finally {
            setFollowLoading(false);
        }
    };

    const handleMessage = () => {
        if (!user) return;
        // Navigate to Chat logic
        navigation.navigate('Chat', { recipientId: user.id, recipientName: user.username });
    };

    const handleShareProfile = async () => {
        try {
            await Share.share({
                message: `Check out @${user?.username} on Netzeal!`,
            });
        } catch (err) {
            console.error('Share error:', err);
        }
    };

    const handlePostPress = (post: Post) => {
        // Navigate to single post view
        navigation.navigate('PostDetail', { postId: post.id });
    };

    const handleOpenWebsite = () => {
        if (user?.website) {
            const url = user.website.startsWith('http') ? user.website : `https://${user.website}`;
            Linking.openURL(url);
        }
    };

    // ============================================================================
    // RENDER HELPERS
    // ============================================================================

    const renderStats = () => (
        <View style={styles.statsRow}>
            <View style={styles.statItem}>
                <Text style={[styles.statNumber, { color: colors.text }]}>{user?.posts_count || 0}</Text>
                <Text style={[styles.statLabel, { color: colors.text }]}>Posts</Text>
            </View>
            <View style={styles.statItem}>
                <Text style={[styles.statNumber, { color: colors.text }]}>
                    {user?.followers_count || 0}
                </Text>
                <Text style={[styles.statLabel, { color: colors.text }]}>Followers</Text>
            </View>
            <View style={styles.statItem}>
                <Text style={[styles.statNumber, { color: colors.text }]}>
                    {user?.following_count || 0}
                </Text>
                <Text style={[styles.statLabel, { color: colors.text }]}>Following</Text>
            </View>
        </View>
    );

    const renderBio = () => (
        <View style={styles.bioContainer}>
            <Text style={[styles.fullName, { color: colors.text }]}>{user?.full_name || user?.username}</Text>
            {user?.category && (
                <Text style={[styles.category, { color: colors.textSecondary }]}>{user.category}</Text>
            )}
            {user?.bio && <Text style={[styles.bio, { color: colors.text }]}>{user.bio}</Text>}
            {user?.website && (
                <TouchableOpacity onPress={handleOpenWebsite}>
                    <Text style={[styles.link, { color: colors.primary }]}>{user.website}</Text>
                </TouchableOpacity>
            )}
        </View>
    );

    const renderActionButtons = () => {
        const isFollowing = user?.is_following;

        return (
            <View style={styles.actionButtonsRow}>
                {/* Follow / Unfollow Button */}
                <TouchableOpacity
                    style={[
                        styles.actionButton,
                        { backgroundColor: isFollowing ? colors.followingBtn : colors.followBtn },
                        { flex: 1 } // Take up space
                    ]}
                    onPress={handleFollowToggle}
                    disabled={followLoading}
                >
                    {followLoading ? (
                        <ActivityIndicator size="small" color={isFollowing ? colors.text : '#fff'} />
                    ) : (
                        <Text style={[
                            styles.actionButtonText,
                            { color: isFollowing ? colors.followingText : colors.followText, fontWeight: '600' }
                        ]}>
                            {isFollowing ? 'Following' : 'Follow'}
                        </Text>
                    )}
                </TouchableOpacity>

                {/* Message Button */}
                <TouchableOpacity
                    style={[styles.actionButton, { backgroundColor: colors.buttonBg, flex: 1 }]}
                    onPress={handleMessage}
                >
                    <Text style={[styles.actionButtonText, { color: colors.text, fontWeight: '600' }]}>Message</Text>
                </TouchableOpacity>

                {/* Share Button (Small) */}
                <TouchableOpacity
                    style={[styles.actionButtonSmall, { backgroundColor: colors.buttonBg }]}
                    onPress={handleShareProfile}
                >
                    <Ionicons name="share-social-outline" size={20} color={colors.text} />
                </TouchableOpacity>
            </View>
        );
    };

    const renderTabs = () => (
        <View style={[styles.tabsContainer, { borderBottomColor: colors.border }]}>
            <TouchableOpacity
                style={[styles.tab, activeTab === 'posts' && styles.tabActive]}
                onPress={() => setActiveTab('posts')}
            >
                <Ionicons
                    name="grid-outline"
                    size={24}
                    color={activeTab === 'posts' ? colors.text : colors.textSecondary}
                />
            </TouchableOpacity>
            <TouchableOpacity
                style={[styles.tab, activeTab === 'reels' && styles.tabActive]}
                onPress={() => setActiveTab('reels')}
            >
                <Ionicons
                    name="play-circle-outline"
                    size={24}
                    color={activeTab === 'reels' ? colors.text : colors.textSecondary}
                />
            </TouchableOpacity>
        </View>
    );

    // Helper to extract image from post object
    const getPostImage = (item: Post) => {
        if (item.thumbnail_url) return item.thumbnail_url;
        if (item.image_url) return item.image_url;
        if (Array.isArray(item.media_urls) && item.media_urls.length > 0) return item.media_urls[0];
        if (typeof item.media_urls === 'string') return item.media_urls; // legacy
        return 'https://via.placeholder.com/150'; // Fallback
    };

    const renderPost = ({ item }: { item: Post }) => {
        return (
            <TouchableOpacity
                style={styles.postItem}
                onPress={() => handlePostPress(item)}
            >
                <Image
                    source={{ uri: getPostImage(item) }}
                    style={styles.postImage}
                    resizeMode="cover"
                />
                {(item.type === 'reel' || item.type === 'video' || item.media_type === 'video') && (
                    <View style={styles.reelBadge}>
                        <Ionicons name="play" size={16} color="#FFFFFF" />
                    </View>
                )}
            </TouchableOpacity>
        );
    };

    const renderListHeader = () => (
        <View style={styles.profileContent}>
            <View style={styles.topSection}>
                {/* Avatar */}
                <View style={styles.avatarContainer}>
                    <View style={[styles.avatarRing, { borderColor: user?.is_following ? colors.textSecondary : colors.primary }]}>
                        {user?.profile_picture ? (
                            <Image
                                source={{ uri: user.profile_picture }}
                                style={styles.avatar}
                            />
                        ) : (
                            <View style={[styles.avatar, styles.avatarPlaceholder, { backgroundColor: colors.border }]}>
                                <Text style={{ fontSize: 24, fontWeight: 'bold', color: colors.text }}>
                                    {user?.username?.charAt(0).toUpperCase() || '?'}
                                </Text>
                            </View>
                        )}
                    </View>
                </View>

                {/* Stats */}
                {renderStats()}
            </View>

            {renderBio()}
            {renderActionButtons()}
            {renderTabs()}
        </View>
    );

    const getFilteredPosts = () => {
        if (activeTab === 'reels') {
            return posts.filter(p => p.type === 'reel' || p.type === 'video' || p.media_type === 'video');
        }
        return posts;
    };

    // ============================================================================
    // MAIN RENDER
    // ============================================================================

    const renderSkeleton = () => (
        <View style={[styles.container, { backgroundColor: colors.background }]}>
            <View style={{ height: 50, borderBottomWidth: 0.5, borderColor: colors.border }} />
            <View style={{ flexDirection: 'row', padding: 16, alignItems: 'center' }}>
                <View style={{ width: 80, height: 80, borderRadius: 40, backgroundColor: colors.cardBg, marginRight: 24, opacity: 0.7 }} />
                <View style={{ flex: 1, flexDirection: 'row', justifyContent: 'space-around' }}>
                    <View style={{ width: 50, height: 40, backgroundColor: colors.cardBg, borderRadius: 4, opacity: 0.7 }} />
                    <View style={{ width: 50, height: 40, backgroundColor: colors.cardBg, borderRadius: 4, opacity: 0.7 }} />
                    <View style={{ width: 50, height: 40, backgroundColor: colors.cardBg, borderRadius: 4, opacity: 0.7 }} />
                </View>
            </View>
            <View style={{ paddingHorizontal: 16, marginBottom: 16 }}>
                <View style={{ width: 150, height: 16, backgroundColor: colors.cardBg, marginBottom: 8, borderRadius: 4, opacity: 0.7 }} />
                <View style={{ width: '100%', height: 12, backgroundColor: colors.cardBg, marginBottom: 4, borderRadius: 4, opacity: 0.7 }} />
                <View style={{ width: '80%', height: 12, backgroundColor: colors.cardBg, borderRadius: 4, opacity: 0.7 }} />
            </View>
            <View style={{ flexDirection: 'row', paddingHorizontal: 16, gap: 8, marginBottom: 16 }}>
                <View style={{ flex: 1, height: 32, backgroundColor: colors.cardBg, borderRadius: 8, opacity: 0.7 }} />
                <View style={{ flex: 1, height: 32, backgroundColor: colors.cardBg, borderRadius: 8, opacity: 0.7 }} />
            </View>
            <View style={{ flexDirection: 'row', flexWrap: 'wrap' }}>
                {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(i => (
                    <View key={i} style={{ width: SCREEN_WIDTH / 3, height: SCREEN_WIDTH / 3, borderWidth: 1, borderColor: colors.background, backgroundColor: colors.cardBg, opacity: 0.7 }} />
                ))}
            </View>
        </View>
    );

    if (loading && !user) {
        return renderSkeleton();
    }

    if (error && !user) {
        return (
            <View style={[styles.container, styles.centerContainer, { backgroundColor: colors.background }]}>
                <Text style={{ color: colors.text, marginBottom: 16 }}>{error}</Text>
                <TouchableOpacity onPress={fetchProfileData} style={{ padding: 10, backgroundColor: colors.primary, borderRadius: 8 }}>
                    <Text style={{ color: '#fff' }}>Retry</Text>
                </TouchableOpacity>
            </View>
        );
    }

    return (
        <View style={[styles.container, { backgroundColor: colors.background }]}>
            <StatusBar barStyle={isDark ? 'light-content' : 'dark-content'} />

            {/* Header */}
            <View style={[styles.header, { paddingTop: insets.top, backgroundColor: colors.background, borderBottomColor: colors.border }]}>
                <TouchableOpacity onPress={() => navigation.goBack()} style={{ padding: 8 }}>
                    <Ionicons name="arrow-back" size={24} color={colors.text} />
                </TouchableOpacity>
                <Text style={[styles.headerTitle, { color: colors.text }]}>{user?.username}</Text>
                <View style={{ width: 40 }} />
            </View>

            <FlatList
                ref={scrollRef}
                data={getFilteredPosts()}
                renderItem={renderPost}
                keyExtractor={(item) => item.id.toString()}
                numColumns={3}
                ListHeaderComponent={renderListHeader}
                refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} tintColor={colors.primary} />}
                contentContainerStyle={{ paddingBottom: insets.bottom }}
                ListEmptyComponent={
                    <View style={{ padding: 32, alignItems: 'center' }}>
                        <Text style={{ color: colors.textSecondary }}>No posts yet</Text>
                    </View>
                }
            />
        </View>
    );
}

// ============================================================================
// STYLES
// ============================================================================
const styles = StyleSheet.create({
    container: {
        flex: 1,
    },
    centerContainer: {
        justifyContent: 'center',
        alignItems: 'center',
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: 8,
        paddingBottom: 8,
        borderBottomWidth: 0.5,
    },
    headerTitle: {
        fontSize: 16,
        fontWeight: '700',
    },
    profileContent: {
        paddingBottom: 0,
    },
    topSection: {
        flexDirection: 'row',
        alignItems: 'center',
        paddingHorizontal: 16,
        paddingTop: 16,
        paddingBottom: 12,
    },
    avatarContainer: {
        marginRight: 24,
    },
    avatarRing: {
        padding: 2,
        borderRadius: 50,
        borderWidth: 2,
    },
    avatar: {
        width: 80,
        height: 80,
        borderRadius: 40,
    },
    avatarPlaceholder: {
        justifyContent: 'center',
        alignItems: 'center',
    },
    statsRow: {
        flex: 1,
        flexDirection: 'row',
        justifyContent: 'space-around',
        alignItems: 'center',
    },
    statItem: {
        alignItems: 'center',
    },
    statNumber: {
        fontSize: 18,
        fontWeight: 'bold',
    },
    statLabel: {
        fontSize: 13,
    },
    bioContainer: {
        paddingHorizontal: 16,
        marginBottom: 16,
    },
    fullName: {
        fontWeight: '700',
        fontSize: 14,
        marginBottom: 2,
    },
    category: {
        fontSize: 12,
        marginBottom: 4,
    },
    bio: {
        fontSize: 14,
        lineHeight: 18,
    },
    link: {
        color: '#00376B',
        fontWeight: '600',
        marginTop: 2,
    },
    actionButtonsRow: {
        flexDirection: 'row',
        paddingHorizontal: 16,
        gap: 8,
        marginBottom: 16,
    },
    actionButton: {
        paddingVertical: 7,
        borderRadius: 8,
        alignItems: 'center',
        justifyContent: 'center',
        minHeight: 32,
    },
    actionButtonText: {
        fontSize: 14,
        fontWeight: '600',
    },
    actionButtonSmall: {
        padding: 6,
        borderRadius: 8,
        alignItems: 'center',
        justifyContent: 'center',
        width: 34,
        height: 34,
    },
    tabsContainer: {
        flexDirection: 'row',
        borderTopWidth: 0.5,
        borderBottomWidth: 0.5,
        borderColor: '#dbdbdb',
        height: 48,
    },
    tab: {
        flex: 1,
        alignItems: 'center',
        justifyContent: 'center',
        borderBottomWidth: 1,
        borderBottomColor: 'transparent',
    },
    tabActive: {
        borderBottomColor: '#000',
    },
    postItem: {
        width: SCREEN_WIDTH / 3,
        height: SCREEN_WIDTH / 3,
        borderWidth: 0.5,
        borderColor: '#fff',
    },
    postImage: {
        width: '100%',
        height: '100%',
    },
    reelBadge: {
        position: 'absolute',
        right: 8,
        top: 8,
        backgroundColor: 'rgba(0,0,0,0.5)',
        borderRadius: 4,
        padding: 2,
    },
});
